<!DOCTYPE html>
<html>
<head>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <link href='/style.css' rel='stylesheet' type='text/css'>
</head>
<body>
    <div>
        <div class="customButton" id="import">Import</div>
        <h1>Filter by time (last)</h1>
        <div><input type="number" value="7" id="days"> Days</div>
        <div><input type="number" id="hours"> Hours</div>
        <div><input type="number" id="minutes"> Minutes</div>
        <div><input type="number" id="seconds"> Seconds</div>
        <h1>Active filters</h1>
        <div style="display: flex; flex-wrap: wrap; width: 100%;" id="filters">
        
        </div>
        <h1>
            <select id="timeUnit">
                <option value="date">Date</option>
                <option value="hour">Hour</option>
                <option value="minute">Minute</option>
            </select>
        </h1>
        <div id="trafficDateContainer">
            <div class="loading"></div>
        </div>
        <h1>Endpoints</h1>
        <div id="endpoints" style="display: flex; flex-wrap: wrap; width: 100%;">
            <div class="loading"></div>
        </div>
        <h1>Countries</h1>
        <div id="countries" style="display: flex; flex-wrap: wrap; width: 100%;">
            <div class="loading"></div>
        </div>
        <h1>Referrers</h1>
        <div id="referrers" style="display: flex; flex-wrap: wrap; width: 100%;">
            <div class="loading"></div>
        </div>
        <h1>Screens</h1>
        <div id="screens" style="display: flex; flex-wrap: wrap; width: 100%;">
            <div class="loading"></div>
        </div>
    </div>
    <script src="/script.js"></script>
    <script>
        const trafficDateContainer = "trafficDateContainer"
        const imp = document.getElementById("import")
        const param = new URLSearchParams(window.location.search)
        const referrers = document.getElementById("referrers")
        const queryString = document.getElementById("querystring")

        param.forEach((v, k) => {
            document.getElementById("filters").innerHTML += `<div>${k}: ${v}</div>`
        })

        document.getElementById("days").value = param.get("days")
        document.getElementById("hours").value = param.get("hours")
        document.getElementById("minutes").value = param.get("minutes")
        document.getElementById("seconds").value = param.get("seconds")
        document.getElementById("timeUnit").value = param.has("timeunit") ? param.get("timeunit") : "date"
        document.getElementById("days").onchange = (ev) => {
            param.set("days", ev.target.value)
            Reload()
        }
        document.getElementById("hours").onchange = (ev) => {
            param.set("hours", ev.target.value)
            Reload()
        }
        document.getElementById("minutes").onchange = (ev) => {
            param.set("minutes", ev.target.value)
            Reload()
        }
        document.getElementById("seconds").onchange = (ev) => {
            param.set("seconds", ev.target.value)
            Reload()
        }
        document.getElementById("timeUnit").onchange = (ev) => {
            param.set("timeunit", ev.target.value)
            Reload()
        }
        ReloadAllData()
        // Display everything
        function Loaded() {
            var currentReload = reloaded
            const layout = {
                font: {
                    color: "#EEEEEE"
                },
                plot_bgcolor: "#222222",
                paper_bgcolor: "#222222"
            }
            fetch("/analytics/time?" + param.toString()).then(res => res.json().then(json => {
                var clicks = {x: [], y: [], fill: 'tozeroy', type: "scatter", line: {color: "#1a9c00", width: 3}, name: "clicks", marker: {size: 8}}
                var users = {x: [], y: [], fill: 'tozeroy', type: "scatter", line: {color: "#00419c", width: 3}, name: "unique ips", marker: {size: 8}}
                var mostClicks = 0
                var mostIps = 0
                var l = param.get("landscape")
                if(l) {
                    json.forEach(element => {
                        if(mostClicks < element.totalClicks) mostClicks = element.totalClicks
                        if(mostIps < element.totalUniqueIPs) totalUniqueIPs = element.totalUniqueIPs
                    })
                }
                json.forEach(element => {
                    clicks.x.push(element.time)
                    clicks.y.push(element.totalClicks)
                    users.x.push(element.time)
                    if(l) users.y.push(mostClicks + 1000 + mostIps - element.totalUniqueIPs)
                    else {
                        users.y.push(element.totalUniqueIPs)
                    }
                });
                document.getElementById(trafficDateContainer).innerHTML = ""
                Plotly.newPlot(trafficDateContainer, [clicks, users], layout)
                document.getElementById(trafficDateContainer).on('plotly_click', function(data){
                    var pts = '';
                    for(var i=0; i < data.points.length; i++){
                        pts = data.points[i].x;
                    }
                    SetTime(pts)
                });
            }).catch(e => {
                console.log(e)
                Issue(currentReload)
            }))
        }
        function SetEndpoint(endpoint) {
            param.set("endpoint", endpoint)
            Reload()
        }
        function SetCountry(country) {
            param.set("countrycode", country)
            Reload()
        }
        function SetReferrer(referrer) {
            param.set("referrer", referrer)
            Reload()
        }
        function SetScreen(width, height) {
            param.set("screenwidth", width)
            param.set("screenheight", height)
            Reload()
        }
        function SetTime(time) {
            param.set("time", time)
            Reload()
        }
        function Reload() {
            window.location.href = "?" + param.toString()
        }
        var reloaded = 0
        function Issue(reload) {
            if(reloaded != reload) return
            reloaded++
            alert("issues detected. Aka probably a gateway timeout. Reloading data.")
            //Loaded()
            //ReloadAllData();
        }
        function ReloadAllData() {
            var currentReload = reloaded
            fetch("/analytics/endpoints?" + param.toString()).then(res => res.json().then(json => {
                document.getElementById("endpoints").innerHTML = ""
                var endpoints = ""
                json.sort((a, b) => {
                    if (a.clicks < b.clicks) return 1;
                    if (a.clicks > b.clicks) return -1;
                    return 0;
                })
                totalClicks = 0
                json.forEach(e => {
                    totalClicks += e.clicks
                })
                json.forEach(e => {
                    endpoints += `<div style="display: flex; flex-direction: column; border: #EEEEEE 1px solid; min-width: 24%; padding: 5px;" onclick="SetEndpoint('${e.endpoint}')">
                                    <a style="font-weight: bold;" href="${e.fullUri}">${e.endpoint}</a>
                                    <div>${e.clicks} clicks (${Math.round(e.clicks / totalClicks * 10000) / 100} %)</div>
                                    <div>${e.uniqueIPs} unique IPs</div>
                                    <div>avg. ${ToElapsed(e.avgDuration)} min per visit</div>
                                </div>`
                })
                document.getElementById("endpoints").innerHTML += endpoints
            }).catch(e => {
                Issue(currentReload)
            }))
            fetch("/analytics/countries?" + param.toString()).then(res => res.json().then(json => {
                document.getElementById("countries").innerHTML = ""
                var countries = ""
                json.sort((a, b) => {
                    if (a.clicks < b.clicks) return 1;
                    if (a.clicks > b.clicks) return -1;
                    return 0;
                })
                totalClicks = 0
                json.forEach(e => {
                    totalClicks += e.clicks
                })
                json.forEach(e => {
                    countries += `<div style="display: flex; flex-direction: column; border: #EEEEEE 1px solid; min-width: 24%; padding: 5px;" onclick="SetCountry('${e.countryCode}')">
                                    <a style="font-weight: bold;" href="${e.fullUri}">${e.countryCode}</a>
                                    <div>${e.clicks} clicks (${Math.round(e.clicks / totalClicks * 10000) / 100} %)</div>
                                    <div>${e.uniqueIPs} unique IPs</div>
                                    <div>avg. ${ToElapsed(e.avgDuration)} min per visit</div>
                                </div>`
                })
                document.getElementById("countries").innerHTML += countries
            }).catch(e => {
                Issue(currentReload)
            }))
            fetch("/analytics/screen?" + param.toString()).then(res => res.json().then(json => {
                document.getElementById("screens").innerHTML = ""
                var total = 0
                json.forEach(e => {
                    total += e.clicks
                })
                json.forEach(e => {
                    document.getElementById("screens").innerHTML += `<div style="display: flex; flex-direction: column; border: #EEEEEE 1px solid; min-width: 24%; padding: 5px;" onclick="SetScreen('${e.screenWidth}', '${e.screenHeight}')">
                                    <div style="font-weight: bold;">${e.screenWidth} x ${e.screenHeight}</div>
                                    <div>${e.clicks} clicks (${Math.round(e.clicks / total * 10000) / 100} %)</div>
                                    <div>${e.uniqueIPs} unique IPs</div>
                                    <div>avg. ${ToElapsed(e.avgDuration)} min per visit</div>
                                </div>`
                });
            }).catch(e => {
                Issue(currentReload)
            }))
            fetch("/analytics/referrers?" + param.toString()).then(res => res.json().then(json => {
                referrers.innerHTML = ""
                var total = 0
                json.sort((a, b) => {
                    if (a.referred < b.referred) return 1;
                    if (a.referred > b.referred) return -1;
                    return 0;
                })
                json.forEach(e => {
                    total += e.referred
                });
                json.forEach(e => {
                    referrers.innerHTML += `<div style="display: flex; flex-direction: column; border: #EEEEEE 1px solid; min-width: 24%; padding: 5px;" onclick="SetReferrer('${e.uri}')">
                                        <a style="font-weight: bold;" href="${e.uri}">${e.uri == "" ? "none" : e.uri}</a>
                                        <div>${e.referred} times referred (${Math.round(e.referred / total * 10000) / 100} %)</div>
                                        <div>${e.uniqueIPs} unique IPs</div>
                                        <div>avg. ${ToElapsed(e.avgDuration)} min per visit</div>
                                    </div>`
                });
            }).catch(e => {
                Issue(currentReload)
            }))
        }
        imp.onclick = () => {
            var input = document.createElement("input")
            input.setAttribute("type", "file")

            input.onchange = function (e) {
                if (!this.files[0]) {
                    return;
                }

                var reader = new FileReader();
                var fileName = this.files[0].name
                reader.onloadend = function () {
                    fetch("/import", {
                        method: "POST",
                        body: reader.result
                    }).then(res => {
                        res.text().then(e => alert(e))
                    })

                }
                reader.readAsArrayBuffer(this.files[0]);
            }

            input.click()
        }
            
            function ToElapsed(input) {
                var date = new Date(0);
                date.setSeconds(input); // specify value for SECONDS here
                var timeString = date.toISOString().substr(14, 5);
                return timeString
        }

        function MakeClean(obj) {
            Object.keys(obj).forEach(key => { obj[key] = obj[key].replaceAll("<", "&lt").replaceAll("<", "&gt") });
            return obj;
        }
    </script>
    <script src="https://cdn.plot.ly/plotly-2.6.3.min.js" onload="Loaded()"></script>
</body>
</html>